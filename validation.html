<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validation</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div id="validation-view">
    <h2 id="page-title">Chargement...</h2>
    <div id="sections"></div>
    <p style="text-align:center; margin-top:30px;">
      <a href="dashboard.html" style="color:#555;">← Retour au dashboard</a>
    </p>
  </div>

  <script type="module">
    import { loadPages, loadStatus, saveStatus, loadHistory, addHistory } from './js/data.js';

    const urlParams = new URLSearchParams(window.location.search);
    const pageId = urlParams.get('page');
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) window.location.href = 'index.html';

    const pages = await loadPages();
    const page = pages.find(p => p.id === pageId);
    if (!page) {
      document.getElementById('page-title').textContent = 'Page non trouvée';
      exit;
    }

    document.getElementById('page-title').textContent = page.title;
    const status = await loadStatus();

    page.sections.forEach(sec => {
      const secStatus = status[pageId][sec.id];
      const isUserValidated = secStatus.validatedBy.includes(user.username);

      let btnHtml = isUserValidated
        ? '<button disabled>Déjà validé</button>'
        : `<button onclick="validateSection('${pageId}', '${sec.id}')">Valider</button>`;

      const commentsHtml = secStatus.comments.map(c =>
        `<div class="comment"><b>${c.user}</b>: ${c.text} (${new Date(c.timestamp).toLocaleString()})</div>`
      ).join('');

      document.getElementById('sections').insertAdjacentHTML('beforeend', `
        <div class="section">
          <h4>${sec.title}</h4>
          <img src="${sec.image}" alt="${sec.title}">
          ${btnHtml}
          <textarea id="comment-${sec.id}" placeholder="Ajouter un commentaire"></textarea>
          <button onclick="addComment('${pageId}', '${sec.id}')">Commenter</button>
          <div class="comments">${commentsHtml}</div>
        </div>
      `);
    });

    async function validateSection(pageId, secId) {
      const status = await loadStatus();
      if (!status[pageId][secId].validatedBy.includes(user.username)) {
        status[pageId][secId].validatedBy.push(user.username);
        await saveStatus(status);
        await addHistory(user.username, 'validate', pageId, secId);
        alert('Section validée !');
        location.reload();
      }
    }

    async function addComment(pageId, secId) {
      const textarea = document.getElementById(`comment-${secId}`);
      const text = textarea.value.trim();
      if (!text) return alert('Veuillez entrer un commentaire');

      const status = await loadStatus();
      status[pageId][secId].comments.push({ user: user.username, text, timestamp: new Date().toISOString() });
      await saveStatus(status);
      await addHistory(user.username, 'comment', pageId, secId, text);
      alert('Commentaire ajouté !');
      location.reload();
    }
  </script>
</body>
</html>